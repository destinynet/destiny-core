/*
 * @author smallufo
 * @date 2005/3/11
 * @time Uと 04:55:04
 */
package destiny.calendar.eightwords;

import destiny.astrology.Coordinate;
import destiny.astrology.Planet;
import destiny.astrology.StarPositionIF;
import destiny.calendar.Location;
import destiny.calendar.Time;
import destiny.core.chinese.EarthlyBranches;
import destiny.core.chinese.HeavenlyStems;

/**
 * w ~氦zやAHのるやAHの传~ICnD るz
 * <BR>
 *  abstract class ヘewgノぃ欷F, эH YearMonthSolarTermsStarPositionImpl ㄓ龟@
 * @see destiny.calendar.eightwords.YearMonthSolarTermsStarPositionImpl
 */
public abstract class AbstractYearBoundaryChangeable
{
  //private StarTransitIF starTransitImpl;
  
  /** s ~氦zや  */
  private static ThreadLocal<HeavenlyStems> yearStemHolder = new ThreadLocal<HeavenlyStems>();
  /** 传~I , q`OミKI (315) 传~ */
  private static ThreadLocal<Double> changeYearDegreeHolder = new ThreadLocal<Double>(); 
  private static ThreadLocal<StarPositionIF> positionImplHolder = new ThreadLocal<StarPositionIF>(); //s StarTransitIF 汗戋@
  
  public AbstractYearBoundaryChangeable(StarPositionIF positionImpl , double degree)
  {
    if (positionImpl == null)
      throw new RuntimeException("positionImpl cannot be null !");
    
    synchronized(this)
    {
      changeYearDegreeHolder.set(new Double(degree));
      positionImplHolder.set(positionImpl);
    }
  }
  
  public AbstractYearBoundaryChangeable()
  {
  }
  
  public void setChangeYearDegree(double degree)
  {
    synchronized(this)
    {
      changeYearDegreeHolder.set(new Double(degree));
    }
  }
  
  protected double getChangeYearDegree()
  {
    synchronized (this)
    {
      return (changeYearDegreeHolder.get()).doubleValue();
    }
  }
  
  protected void setYearStem(HeavenlyStems yearStem)
  {
    synchronized(this)
    {
      yearStemHolder.set(yearStem);
    }
  }
  
  private HeavenlyStems getYearStem()
  {
    synchronized(this)
    {
      return yearStemHolder.get();  
    }
  }
  
  private StarPositionIF getPositionImpl()
  {
    synchronized(this)
    {
      return positionImplHolder.get();
    }
  }
  
  /**
   * @param lmt
   * @param るや
   * @return oるz
   */
  protected HeavenlyStems getMonthStem(Time lmt , Location location , EarthlyBranches るや)
  {
    if (changeYearDegreeHolder.get() == null)
      throw new RuntimeException("State Error , changeYearDegree should have been set.");
    if (yearStemHolder.get() == null)
      throw new RuntimeException("State Error , yearStem should have been set.");
    
    double changeYearDegree = this.getChangeYearDegree();
    HeavenlyStems ~z = this.getYearStem();
    
    HeavenlyStems るz = null;
    
    //System.out.println("~z = " + ~z + " , るや == " + るや + " , changeYearDegree = " + changeYearDegree);
    
    switch (HeavenlyStems.getIndex(~z))
    {
      case 0 : case 5 : るz = るや.getIndex() >=2 ? (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)   ) ) : (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+2 ) ) ; break;  
      case 1 : case 6 : るz = るや.getIndex() >=2 ? (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+2 ) ) : (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+4 ) ) ; break;
      case 2 : case 7 : るz = るや.getIndex() >=2 ? (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+4 ) ) : (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+6 ) ) ; break;
      case 3 : case 8 : るz = るや.getIndex() >=2 ? (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+6 ) ) : (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+8 ) ) ; break;
      case 4 : case 9 : るz = るや.getIndex() >=2 ? (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+8 ) ) : (HeavenlyStems.getHeavenlyStems(EarthlyBranches.getIndex(るや)+10) ) ; break;
      default : throw new RuntimeException("~z == null !!! Wrong");
    }
    
    if (changeYearDegree != 315)
    {
      StarPositionIF positionImpl = getPositionImpl();
      if (positionImpl == null)
        throw new RuntimeException("Call state error ! starTransitImpl should be set.");
      
      Time gmt = new Time(lmt , 0-location.getMinuteOffset()*60);
        
      positionImpl.setCoordinate(Coordinate.ECLIPTIC);
      if (changeYearDegree < 315)
      {
        //System.out.println("changeYearDegree < 315 , value = " + changeYearDegree);
        //传~IbミKe
        
        double lmtSunDegree = positionImpl.getPosition(Planet.SUN , gmt ).getLongitude();
        //System.out.println("LMT = " + lmt + " degree = " + lmtSunDegree);
        if (lmtSunDegree > changeYearDegree && 315 > lmtSunDegree)
        {
          // t <---ミK---- LMT -----传~I
          るz = HeavenlyStems.getHeavenlyStems(るz.getIndex() - 2);
        }
      }
      else if (changeYearDegree > 315)
      {
        //传~IbミK , 临S代刚
        double lmtSunDegree = positionImpl.getPosition(Planet.SUN , gmt ).getLongitude();
        if (lmtSunDegree > 315 && changeYearDegree > lmtSunDegree)
          るz = HeavenlyStems.getHeavenlyStems(るz.getIndex() + 2);
      }
    }      
    return るz;
  }//getMonthStem
}
